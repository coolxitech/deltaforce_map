import{g as e,E as t,v as s}from"./vendor-element-CZ4qweVa.js";import{o as a,b as n,a as o,s as r,r as i,aZ as l,c,j as m,e as d,V as p,q as u,m as h,X as y,k as f,u as v,F as g,g as w}from"./vendor-framework-DHKCbjaO.js";import{S as $,g as x,c as b,a as k}from"./app-core-BM2i85hQ.js";import{V as B,S as E,M as A,C as T,_ as j}from"./common-components-CzyqGHb7.js";import{aw as S}from"./vendor-others-BtQpESy4.js";import{a as _}from"./vendor-axios-VSpmzgsF.js";import{p as K,d as L}from"./vendor-compress-BdR2XO1K.js";import"./vendor-leaflet-DjxZjbfc.js";import"./vendor-icons-De-qXahv.js";class M{constructor(){this.items=new Map}makeKey(e){return`${e.name}|${e.position.x},${e.position.y}|${e.grade}|${e.price}`}add(e){const t=this.makeKey(e);this.items.set(t,{...e,id:e.id??""})}remove(e){const t=this.makeKey(e);return this.items.delete(t)}get(e){const t=this.makeKey(e),s=this.items.get(t);return s?{...s}:null}list(){return Array.from(this.items.values(),e=>({...e}))}find(e){return this.list().filter(e)}findByPosition(e,t){return this.find(s=>s.position.x===e&&s.position.y===t)[0]??null}findByName(e){return this.find(t=>t.name===e)}clear(){this.items.clear()}get size(){return this.items.size}}class C{constructor(){this.players=new Map,this.cheatTeam=new Map}add(e){const t=e.name,s=this.players.get(t);s?Object.assign(s,e):this.players.set(t,{...e}),e.isCheater?this.cheatTeam.has(t)?Object.assign(this.cheatTeam.get(t),e):this.cheatTeam.set(t,this.players.get(t)):this.cheatTeam.delete(t)}remove(e){const t="string"==typeof e?e:e.name;this.players.delete(t),this.cheatTeam.delete(t)}get(e){return this.players.get(e)??null}list(){return Array.from(this.players.values())}listCheaters(){return Array.from(this.cheatTeam.values())}clear(){this.players.clear(),this.cheatTeam.clear()}findBots(){return this.list().filter(e=>e.isBot)}findByTeam(e){return this.list().filter(t=>t.teamId===e)}findByRoleAlias(e){return this.list().filter(t=>t.roleAlias===e)}findByWeapon(e){return this.list().filter(t=>t.weapon===e)}}class O{constructor(){this.boxes=new Map}makeKey(e){return`${e.isBot?1:0}|${e.position.x},${e.position.y}`}add(e){const t=this.makeKey(e);this.boxes.set(t,{...e})}remove(e){return this.boxes.delete(this.makeKey(e))}get(e){return this.boxes.get(this.makeKey(e))??null}list(){return Array.from(this.boxes.values())}clear(){this.boxes.clear()}findByPosition(e,t){const s=`0|${e},${t}`,a=`1|${e},${t}`;return this.boxes.get(s)??this.boxes.get(a)??null}findBotBoxes(){return this.list().filter(e=>e.isBot)}findPlayerBoxes(){return this.list().filter(e=>!e.isBot)}}const z={class:"app-container"},I=["element-loading-text"],P={class:"map-wrapper"},V=j(o({__name:"Home",setup(o){!function(){const e=()=>{const e=document.documentElement,t=e.clientWidth;if(!t)return;const s=t>1720?100*t/1920:172e3/1920;e.style.fontSize=`${s}px`};e();const t=setTimeout(e,300),s=()=>e();a(()=>{window.addEventListener("load",e),window.addEventListener("orientationchange"in window?"orientationchange":"resize",s),document.addEventListener("DOMContentLoaded",e)}),n(()=>{clearTimeout(t),window.removeEventListener("load",e),window.removeEventListener("orientationchange"in window?"orientationchange":"resize",s),document.removeEventListener("DOMContentLoaded",e)})}();const j=$(),{loading:V,itemsInfo:H}=r(j),N=i("挂狗还没进游戏，去找找其他房间吧...");let W,J=i([]),D=i([]),U=i([]),q=0;const F=i([]),R=new M,X=new O,Z=new C,G=e=>{try{if(!e||!Array.isArray(e.items))return;const t=e.items,s=new Set;t.forEach(e=>{const t=`${e.name}|${e.position.x},${e.position.y}|${e.grade}|${e.price}`;s.add(t);R.get({name:e.name,position:e.position,grade:e.grade,price:e.price})?(R.remove({name:e.name,position:e.position,grade:e.grade,price:e.price}),R.add(e)):R.add(e)});const a=R.list(),n=[];a.forEach(e=>{const t=`${e.name}|${e.position.x},${e.position.y}|${e.grade}|${e.price}`;s.has(t)||n.push(e)}),n.forEach(e=>{R.remove({name:e.name,position:e.position,grade:e.grade,price:e.price})}),D.value=R.list()}catch(t){console.error("itemHandler error:",t)}},Q=e=>{try{if(!e||!Array.isArray(e.boxes))return;const t=e.boxes,s=new Set;t.forEach(e=>{const t=`${e.isBot?1:0}|${e.position.x},${e.position.y}`;s.add(t);X.get(e)?(X.remove(e),X.add(e)):X.add(e)});const a=X.list(),n=[];a.forEach(e=>{const t=`${e.isBot?1:0}|${e.position.x},${e.position.y}`;s.has(t)||n.push(e)}),n.forEach(e=>X.remove(e)),J.value=X.list()}catch(t){console.error("boxHandler error:",t)}},Y=e=>{try{if(!e||!Array.isArray(e.players))return;const t=e.players,s=new Set;t.forEach(e=>{s.add(e.name),Z.add(e)});Z.list().forEach(e=>{s.has(e.name)||Z.remove(e)}),U.value=Z.list(),F.value=Z.listCheaters()}catch(t){console.error("playerHandler error:",t)}},ee=i(x("address")),te=i(x("type")??"un");l();const se=i("daba"),ae=i(!1);let ne;return ee?.value?("un"===te.value?(ne=new WebSocket("ws://"+ee.value),ne.onopen=async()=>{console.log("已连接挂狗地图,正在获取挂狗地图的鉴权...");const e=await _.get(`http://deltaforce.coolxi.eu.org/api/token?address=${ee.value}`);W=e.data.data.token,ne.send(JSON.stringify({token:W}))},ne.onmessage=async e=>{try{let t;if(e.data instanceof Blob){const s=await e.data.text();t=JSON.parse(s)}else{if("string"!=typeof e.data)return void console.error("接收数据异常");t=JSON.parse(e.data)}if("auth"===t?.type&&t?.success)return void console.info("挂狗服务器鉴权成功");const s=b(t,H.value);G(s),Q(s),Y(s),se.value=s.map.name,V.value=""===s.map.name}catch(t){console.error("解析数据时出错:",t)}},ne.onclose=e=>{console.log("服务器断开了连接:"+e.reason)}):"ray"===te.value&&(ne=new WebSocket("ws://"+ee.value+"/web"),ne.binaryType="arraybuffer",ne.onopen=async()=>{console.log("已连接挂狗地图,正在获取挂狗地图的原始数据...")},ne.onmessage=async t=>{let s,a;if(s=t.data,1!=s.length)if("userType"!==s?.type)if("permissions"!==s?.type){if(t.data instanceof ArrayBuffer)try{const e=new Uint8Array(s),t=K.inflate(e),n=L(t);void 0!==n.t&&0!==n.t&&(q=n.t),a=await k(n,H.value,q),G(a),Q(a),Y(a),se.value=a.map.name,V.value=!1}catch(n){return}}else e({title:"提示",message:`\n              显示玩家:${s.permissions?.normal.enablePlayers?"同意":"拒绝"}\n              显示人机:${s.permissions?.normal.enableAI?"同意":"拒绝"}\n              显示物资:${s.permissions?.normal.enableItems?"同意":"拒绝"}\n            `,type:"warning"});else e("normal"===s?.userType?{title:"提示",message:"挂狗开房完全权限,可看全部数据",type:"warning"}:{title:"提示",message:"挂狗开房部分权限,可看部分数据",type:"warning"});else V.value=!0}),ne.onclose=()=>{e({title:"提示",message:"挂狗不让看了，换个房间吧.",type:"error"}),console.log("已断开挂狗地图")}):(e({title:"Man!",message:"当前是快照版，有缺陷，正式版敬请期待.",type:"warning"}),N.value="不是哥们，找个挂狗再来看吧。",V.value=!1),(e,a)=>{const n=t,o=s;return w(),c(g,null,[m(B),d("div",z,[d("div",{class:h(["navbar",{"panel-open":ae.value}]),style:u({zIndex:ae.value?1:999999,pointerEvents:ae.value?"none":"auto"})},[a[2]||(a[2]=d("div",{class:"logo"},[d("img",{src:"/assets/png/logo-ktrPmT5r.png",alt:"logo"})],-1)),p(d("div",{class:"right-btn",onClick:a[0]||(a[0]=e=>ae.value=!0)},[m(n,{color:"#ffffff"},{default:f(()=>[m(v(S))]),_:1})],512),[[y,!ae.value]])],6),m(E,{modelValue:ae.value,"onUpdate:modelValue":a[1]||(a[1]=e=>ae.value=e)},null,8,["modelValue"]),p((w(),c("div",{class:"main-content","element-loading-text":N.value},[d("div",P,[m(A,{map:se.value,players:v(U),items:v(D),boxes:v(J)},{default:f(()=>[...a[3]||(a[3]=[d("div",{class:"img_map_mask"},null,-1)])]),_:1},8,["map","players","items","boxes"])])],8,I)),[[o,v(V)]]),m(T)])],64)}}}),[["__scopeId","data-v-ef8e43e1"]]);export{V as default};
